name: Deploy on Local Cloud

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: self-hosted
    environment: production
    env:
      COMPOSE_PROJECT_NAME: authify
      POSTGRES_USER: ${{ env.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ env.POSTGRES_PASS }}
      POSTGRES_DB: ${{ env.POSTGRES_DB }}
      VIRTUAL_HOST: ${{ env.VIRTUAL_HOST }}
      VIRTUAL_PORT: ${{ env.VIRTUAL_PORT }}
      DATABASE_URL: "postgres://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASS }}@db:5432/${{ env.POSTGRES_DB }}"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check env vars 1
        run: |
          echo "DATABASE_URL: ${{ env.DATABASE_URL }}"
          echo "POSTGRES_USER: ${{ env.POSTGRES_USER }}"
          echo "POSTGRES_PASSWORD: ${{ env.POSTGRES_PASS }}"
          echo "POSTGRES_DB: ${{ env.POSTGRES_DB }}"
          echo "VIRTUAL_HOST: ${{ env.VIRTUAL_HOST }}"
          echo "VIRTUAL_PORT: ${{ env.VIRTUAL_PORT }}"

      - name: Shut Down Existing Containers
        run: docker compose down

      - name: Build and Start Containers
        run: docker compose up -d --build

      - name: Show Status of Containers
        run: docker compose ps
